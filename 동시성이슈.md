# 동시성이슈
> 동시성 프로그래밍과 병렬성 프로그래밍에서 동기화가 필요한 이유에 대해 알아봅시다
<br>

## 동시성 프로그래밍에서 발생할 수 있는 문제점
동시성 프로그래밍에서 CPU와 RAM 중간에 위치하는 CPU Cache Memory와 병렬성이라는 특징 때문에 가시성, 원자성 문제가 발생할 수 있다
<br>

- 가시성 문제
- 원자성(동시 접근) 문제

<br>

위 내용의 두 문제는 동시성보단 병렬성 때문에 발생하는 문제지만 자바 스레드는 동시성의 성질을 가지고 있으므로, 자바에서는 동시성 프로그래밍에서 발생하는 문제점이라 부른다

<br>

### 가시성 문제
여러 개의 스레드가 사용됨에 따라 CPU Cache Memory와 RAM의 데이터가 서로 일치하지 않아 생기는 문제를 의미한다

<br>

#### 해결방법
가시성이 보장되어야 하는 변수를 CPU Cache Memory가 아니라 RAM에서 바로 읽도록 보장해야 한다
- 이 때 변수에 `volatile` 키워드를 사용하여 가시성을 보장할 수 있다

<br>

그러나 가시성만 보장된다고 동시성이 보장되는 것은 아니다 
<br>

`volatile` 키워드는 어디까지나 `volatile` 변수를 메인 메모리로 부터 읽을 수 있게 해주는게 전부이다 그러므로 다른 스레드에 의해 언제든 값이 바뀔 수 있다
<br>

즉, 가시성이란 공유 데이터를 읽는 경우의 동시성만 보장한다

<br>

### 원자성 문제
한 줄의 프로그램 문장이 컴파일 과정에서 기계어로 변경되면서 이를 순차적으로 처리하기 위해 여러 개의 Machine Instruction이 만들어져 실행되기 때문에 일어나는 현상

<br>

- 예시 : `i++` 문장은 다음과 같은 기계가 수행하는 명령어로 쪼개진다
  -  i를 메모리로 부터 읽는다
  -  읽은 값에 1을 더한다
  -  연산한 값을 메모리에 저장한다
- 멀티 스레드의 환경에서는 한 스레드가 각 기계 명령어를 수행하는 동안에 다른 스레드가 개입하여 공유변수에 접근하여 같은 기계 명령어를 수행할 수 있으므로 값이 꼬이게 된다

<br>

#### 해결방법
원자성 문제를 해결하기 위해서는 `synchronized` 또는 `atomic`을 사용해야 한다
- 원자성 문제를 `synchronized` 또는 `atomic`을 통해 해결한다면 가시성의 문제도 해결된다
  - `synchronized` : `synchronized` 블럭을 들어가기 전에 CPU Cache Memory와 Main Memory를 동기화 해주기 때문에 가시성 문제가 해결된다
  - `atomic` : CAS알고리즘에 의해 원자성 문제와 CPU Cache Memory에 잘못된 값을 참조하는 문제를 동시에 해결해준다
<br>

CAS 알고리즘이란?
<br>

CPU Cache Memory와 RAM을 비교하여 일차한다면 CPU Cache Memory와 RAM에 적용하고, 일치하지 않는다면 재시도 하면서 어떠한 스레드에서 공유 자원에 읽기/쓰기 작업을 하더라도 원자성을 보장한다
